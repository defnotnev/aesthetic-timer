<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultimate Study Widget</title>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  rel="stylesheet"
/>
<style>
  :root {
    --bg-dark: #1a1a1a;
    --bg-light: #fefefe;
    --text-dark: #fcf1f6;
    --text-light: #1a1a1a;
    --title-dark: #ad1a72;
    --title-light: #ad1a72;
    --outline-dark: rgba(255 255 255 / 0.12);
    --outline-light: rgba(0 0 0 / 0.12);
    --input-bg-dark: #222;
    --input-bg-light: #eee;
  }

  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
  }

  body[data-theme='dark'] {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  body[data-theme='light'] {
    background: var(--bg-light);
    color: var(--text-light);
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--outline-dark);
    background-color: inherit;
  }
  body[data-theme='light'] header {
    border-color: var(--outline-light);
  }
  header h1 {
    font-weight: 900;
    font-size: 1.6rem;
    color: var(--title-dark);
    margin: 0;
  }
  #theme-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.8rem;
    color: var(--title-dark);
    position: relative;
    width: 2.5rem;
    height: 2.5rem;
  }
  #icon-sun, #icon-moon {
    position: absolute;
    top: 0; left: 0;
    right: 0; bottom: 0;
    margin: auto;
    transition: opacity 0.3s ease;
  }
  body[data-theme='dark'] #icon-sun {
    opacity: 0;
  }
  body[data-theme='light'] #icon-moon {
    opacity: 0;
  }

  nav#tabs {
    display: flex;
    background: inherit;
    border-bottom: 1px solid var(--outline-dark);
  }
  body[data-theme='light'] nav#tabs {
    border-color: var(--outline-light);
  }
  nav#tabs button {
    flex: 1 1 0;
    border: none;
    background: none;
    cursor: pointer;
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    font-size: 1rem;
    color: var(--title-dark);
    border-bottom: 3px solid transparent;
    transition: border-color 0.3s ease, background-color 0.3s ease;
  }
  nav#tabs button[aria-selected="true"] {
    border-color: var(--title-dark);
    font-weight: 900;
    background-color: rgba(173, 26, 114, 0.12);
  }
  nav#tabs button:hover:not([aria-selected="true"]) {
    background-color: rgba(173, 26, 114, 0.08);
  }

  main {
    height: calc(100vh - 104px);
    overflow-y: auto;
    padding: 1rem 1.5rem 2rem 1.5rem;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    position: relative;
  }

  /* Transparent blurred rectangle container */
  .blurred-outline {
    background: rgba(255 255 255 / 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid var(--outline-dark);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  body[data-theme='light'] .blurred-outline {
    background: rgba(0 0 0 / 0.04);
    border-color: var(--outline-light);
  }

  section[role="tabpanel"] {
    display: none;
  }
  section[role="tabpanel"].active {
    display: block;
  }

  /* To-Do List styles */
  #todo-list {
    list-style: none;
    margin: 0 0 0.5rem 0;
    padding: 0;
    max-height: 350px;
    overflow-y: auto;
  }
  #todo-list li {
    display: flex;
    align-items: center;
    padding: 0.4rem 0.5rem;
    border-bottom: 1px solid var(--outline-dark);
    position: relative;
  }
  body[data-theme='light'] #todo-list li {
    border-color: var(--outline-light);
  }
  #todo-list li.todo-item.dragging {
    opacity: 0.5;
  }

  /* Bullet buttons */
  .bullet {
    border: none;
    background: none;
    cursor: pointer;
    margin-right: 0.5rem;
    font-size: 1.3rem;
    color: var(--title-dark);
    flex-shrink: 0;
  }
  .bullet:hover {
    color: #ff69b4;
  }

  /* Filled and outline hearts/stars */
  .heart-outline { color: var(--title-dark); }
  .heart-fill { color: #e91e63; }
  .star-outline { color: var(--title-dark); }
  .star-fill { color: #e91e63; }

  /* Task text */
  .todo-text {
    flex-grow: 1;
    outline: none;
    font-size: 1.1rem;
    word-break: break-word;
    padding: 0.1rem 0.2rem;
    min-height: 1.3rem;
  }
  .todo-text.completed {
    text-decoration: line-through;
    opacity: 0.6;
  }

  /* Due date */
  .due-date {
    margin-left: 1rem;
    font-size: 0.85rem;
    cursor: pointer;
    color: var(--title-dark);
    user-select: none;
  }
  .due-date.placeholder {
    opacity: 0.3;
    font-style: italic;
  }
  .due-date:hover {
    text-decoration: underline;
  }

  /* Remove task button */
  .close-btn {
    background: none;
    border: none;
    color: var(--title-dark);
    cursor: pointer;
    margin-left: 1rem;
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  .close-btn:hover {
    color: #ff4081;
  }

  /* Input container */
  #todo-input-container {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
  }
  #todo-input {
    flex-grow: 1;
    font-size: 1.1rem;
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
    border: 1px solid var(--outline-dark);
    background-color: var(--input-bg-dark);
    color: var(--text-dark);
    transition: border-color 0.3s ease;
    user-select: text;
  }
  body[data-theme='light'] #todo-input {
    border-color: var(--outline-light);
    background-color: var(--input-bg-light);
    color: var(--text-light);
  }
  #todo-input:focus {
    border-color: #ad1a72;
    outline: none;
  }

  #todo-toggle-subtask {
    margin-right: 0.75rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--title-dark);
    transition: color 0.3s ease;
  }
  #todo-toggle-subtask.active {
    color: #e91e63;
  }
  #todo-toggle-subtask:hover {
    color: #ff69b4;
  }

  /* Reset button */
  .reset-btn {
    margin-top: 1rem;
    padding: 0.45rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background-color: var(--title-dark);
    color: #fff;
    font-weight: 700;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  .reset-btn:hover {
    background-color: #6f1351;
  }

  /* Countdown and timers container */
  .timer-list, .countdown-list {
    max-height: 320px;
    overflow-y: auto;
    margin-bottom: 1rem;
  }

  /* Countdown & Timers cards */
  .timer-card, .countdown-card {
    background: rgba(255 255 255 / 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid var(--outline-dark);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.8rem;
    position: relative;
  }
  body[data-theme='light'] .timer-card, body[data-theme='light'] .countdown-card {
    background: rgba(0 0 0 / 0.04);
    border-color: var(--outline-light);
  }
  .timer-card > *, .countdown-card > * {
    margin: 0.15rem 0;
  }

  /* Titles editable */
  .editable-title {
    font-weight: 900;
    font-size: 1.2rem;
    color: var(--title-dark);
    user-select: text;
    outline: none;
  }

  /* Countdown timer text */
  .countdown-time {
    font-size: 1.6rem;
    font-weight: 900;
    font-family: monospace, monospace;
    color: var(--text-dark);
    user-select: none;
  }
  body[data-theme='light'] .countdown-time {
    color: var(--text-light);
  }

  /* Control buttons for timers/countdowns */
  .timer-controls button,
  .countdown-controls button {
    background: none;
    border: none;
    color: var(--title-dark);
    cursor: pointer;
    font-size: 1.25rem;
    margin-left: 0.5rem;
    transition: color 0.3s ease;
  }
  .timer-controls button:hover,
  .countdown-controls button:hover {
    color: #e91e63;
  }

  /* Close button for timers/countdowns */
  .close-btn-timer {
    position: absolute;
    top: 0.5rem;
    right: 0.6rem;
    font-size: 1.3rem;
    cursor: pointer;
    color: var(--title-dark);
    background: none;
    border: none;
  }
  .close-btn-timer:hover {
    color: #ff4081;
  }

  /* Input for date/time */
  input[type="date"],
  input[type="time"] {
    padding: 0.3rem 0.5rem;
    border-radius: 8px;
    border: 1px solid var(--outline-dark);
    background-color: var(--input-bg-dark);
    color: var(--text-dark);
    font-size: 1rem;
  }
  body[data-theme='light'] input[type="date"],
  body[data-theme='light'] input[type="time"] {
    border-color: var(--outline-light);
    background-color: var(--input-bg-light);
    color: var(--text-light);
  }
  input[type="date"]:focus,
  input[type="time"]:focus {
    outline: none;
    border-color: #ad1a72;
  }

  /* Pomodoro */
  #pomodoro-display {
    font-size: 3rem;
    font-weight: 900;
    font-family: monospace, monospace;
    text-align: center;
    margin: 2rem 0 1rem 0;
    color: var(--text-dark);
  }
  body[data-theme='light'] #pomodoro-display {
    color: var(--text-light);
  }
  #pomodoro-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }
  #pomodoro-controls button {
    background: none;
    border: 2px solid var(--title-dark);
    border-radius: 50%;
    color: var(--title-dark);
    width: 3rem;
    height: 3rem;
    font-size: 1.5rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #pomodoro-controls button:hover {
    background-color: #ff69b4;
    color: white;
  }

  /* Stopwatch */
  #stopwatch-display {
    font-size: 3rem;
    font-weight: 900;
    font-family: monospace, monospace;
    text-align: center;
    margin-bottom: 1rem;
    color: var(--text-dark);
  }
  body[data-theme='light'] #stopwatch-display {
    color: var(--text-light);
  }
  #stopwatch-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  #stopwatch-controls button {
    background: none;
    border: 2px solid var(--title-dark);
    border-radius: 8px;
    color: var(--title-dark);
    padding: 0.4rem 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #stopwatch-controls button:hover {
    background-color: #ff69b4;
    color: white;
  }

  #punches-list {
    max-height: 160px;
    overflow-y: auto;
    background: rgba(255 255 255 / 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid var(--outline-dark);
    border-radius: 12px;
    padding: 0.5rem 1rem;
    font-family: monospace, monospace;
    color: var(--text-dark);
  }
  body[data-theme='light'] #punches-list {
    background: rgba(0 0 0 / 0.04);
    border-color: var(--outline-light);
    color: var(--text-light);
  }
  #punches-list li {
    margin-bottom: 0.3rem;
  }

  /* Settings tab */
  #settings form {
    max-width: 460px;
    margin: auto;
  }
  #settings label {
    display: block;
    margin-top: 1rem;
    font-weight: 700;
    color: var(--title-dark);
  }
  #settings input[type="color"],
  #settings input[type="text"] {
    margin-top: 0.3rem;
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--outline-dark);
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
  }
  body[data-theme='light'] #settings input[type="color"],
  body[data-theme='light'] #settings input[type="text"] {
    border-color: var(--outline-light);
  }
  #settings button {
    margin-top: 1rem;
    background-color: var(--title-dark);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1.2rem;
    font-weight: 700;
    cursor: pointer;
  }
  #settings button:hover {
    background-color: #6f1351;
  }
  #settings small {
    font-style: italic;
    color: var(--text-dark);
  }
  body[data-theme='light'] #settings small {
    color: var(--text-light);
  }

  /* Background reposition */
  #bg-reposition-container {
    margin-top: 1rem;
    position: relative;
    border: 1px solid var(--outline-dark);
    border-radius: 12px;
    overflow: hidden;
    max-width: 100%;
    height: 180px;
  }
  body[data-theme='light'] #bg-reposition-container {
    border-color: var(--outline-light);
  }
  #bg-reposition-image {
    position: absolute;
    top: 0; left: 0;
    user-select: none;
    cursor: grab;
    max-width: none;
  }
  #bg-reposition-image.dragging {
    cursor: grabbing;
  }
  #bg-reposition-controls {
    margin-top: 0.6rem;
    display: flex;
    justify-content: space-between;
  }
  #bg-reposition-controls button {
    padding: 0.3rem 0.7rem;
    border: none;
    background: var(--title-dark);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }
  #bg-reposition-controls button:hover {
    background: #6f1351;
  }

  /* Chat AI */
  #chat-container {
    max-width: 700px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: 500px;
  }
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
    border-radius: 12px;
    background: rgba(255 255 255 / 0.1);
    color: var(--text-dark);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1rem;
    margin-bottom: 0.6rem;
  }
  body[data-theme='light'] #chat-messages {
    background: rgba(0 0 0 / 0.04);
    color: var(--text-light);
  }
  .chat-message {
    margin-bottom: 1rem;
  }
  .chat-message.user {
    text-align: right;
  }
  .chat-message.user .msg-text {
    display: inline-block;
    background: #e91e63;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 12px 12px 0 12px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .chat-message.ai .msg-text {
    display: inline-block;
    background: rgba(173, 26, 114, 0.8);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 12px 12px 12px 0;
    max-width: 70%;
    word-wrap: break-word;
  }
  #chat-input-container {
    display: flex;
    gap: 0.5rem;
  }
  #chat-input {
    flex-grow: 1;
    font-size: 1rem;
    padding: 0.5rem 0.7rem;
    border-radius: 12px;
    border: 1px solid var(--outline-dark);
    background-color: var(--input-bg-dark);
    color: var(--text-dark);
  }
  body[data-theme='light'] #chat-input {
    border-color: var(--outline-light);
    background-color: var(--input-bg-light);
    color: var(--text-light);
  }
  #chat-input:focus {
    outline: none;
    border-color: #ad1a72;
  }
  #chat-send-btn {
    background: #ad1a72;
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    padding: 0 1.2rem;
  }
  #chat-send-btn:hover {
    background: #6f1351;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: #ad1a72;
    border-radius: 8px;
  }

</style>
</head>
<body data-theme="dark">
<header>
  <h1 contenteditable="true" id="app-title" aria-label="App Title">🎀 Countdown & Timers 🎀</h1>
  <button id="theme-toggle" aria-label="Toggle Dark/Light Theme" title="Toggle Dark/Light Theme">
    <i id="icon-sun" class="fas fa-sun"></i>
    <i id="icon-moon" class="fas fa-moon"></i>
  </button>
</header>
<nav id="tabs" role="tablist" aria-label="Main Sections">
  <button role="tab" id="tab-todo" aria-controls="panel-todo" aria-selected="true">📝 To-Do</button>
  <button role="tab" id="tab-countdown" aria-controls="panel-countdown" aria-selected="false">⏳ Countdown</button>
  <button role="tab" id="tab-timers" aria-controls="panel-timers" aria-selected="false">⏲️ Timers</button>
  <button role="tab" id="tab-stopwatch" aria-controls="panel-stopwatch" aria-selected="false">⏱️ Stopwatch</button>
  <button role="tab" id="tab-pomodoro" aria-controls="panel-pomodoro" aria-selected="false">🍅 Pomodoro</button>
  <button role="tab" id="tab-settings" aria-controls="panel-settings" aria-selected="false">⚙️ Settings</button>
  <button role="tab" id="tab-chat" aria-controls="panel-chat" aria-selected="false">🤖 Chat AI</button>
</nav>
<main>
  <!-- To-Do Tab -->
  <section role="tabpanel" id="panel-todo" tabindex="0" class="active" aria-labelledby="tab-todo">
    <ul id="todo-list" aria-live="polite" aria-label="To-do list"></ul>
    <div id="todo-input-container">
      <button id="todo-toggle-subtask" aria-label="Toggle subtask mode" title="Toggle subtask mode" aria-pressed="false">
        <i class="far fa-heart"></i>
      </button>
      <input
        type="text"
        id="todo-input"
        placeholder="Type a task and press Enter"
        aria-label="Task input"
        autocomplete="off"
      />
    </div>
    <button id="todo-clear" class="reset-btn" aria-label="Clear all tasks">Clear All Tasks</button>
  </section>

  <!-- Countdown Tab -->
  <section role="tabpanel" id="panel-countdown" tabindex="0" aria-labelledby="tab-countdown" >
    <div class="blurred-outline">
      <label for="countdown-title-input" style="font-weight:700; color: var(--title-dark)">Countdown Title:</label>
      <input type="text" id="countdown-title-input" placeholder="🎀 Countdown 🎀" />
    </div>
    <div id="countdown-list" class="countdown-list" aria-live="polite"></div>
    <button id="countdown-add" class="reset-btn" aria-label="Add new countdown">Add Countdown</button>
    <button id="countdown-clear" class="reset-btn" aria-label="Clear all countdowns">Clear All Countdowns</button>
  </section>

  <!-- Timers Tab -->
  <section role="tabpanel" id="panel-timers" tabindex="0" aria-labelledby="tab-timers">
    <div class="blurred-outline">
      <label for="timers-title-input" style="font-weight:700; color: var(--title-dark)">Timers Title:</label>
      <input type="text" id="timers-title-input" placeholder="⏲️ Timers" />
    </div>
    <div id="timer-list" class="timer-list" aria-live="polite"></div>
    <button id="timer-add" class="reset-btn" aria-label="Add new timer">Add Timer</button>
    <button id="timer-clear" class="reset-btn" aria-label="Clear all timers">Clear All Timers</button>
  </section>

  <!-- Stopwatch Tab -->
  <section role="tabpanel" id="panel-stopwatch" tabindex="0" aria-labelledby="tab-stopwatch">
    <div id="stopwatch-display" aria-live="polite" aria-atomic="true">00:00:00.00</div>
    <div id="stopwatch-controls">
      <button id="stopwatch-start">Start</button>
      <button id="stopwatch-pause">Pause</button>
      <button id="stopwatch-reset">Reset</button>
      <button id="stopwatch-punch">Punch</button>
    </div>
    <ul id="punches-list" aria-live="polite" aria-label="Stopwatch punches"></ul>
  </section>

  <!-- Pomodoro Tab -->
  <section role="tabpanel" id="panel-pomodoro" tabindex="0" aria-labelledby="tab-pomodoro">
    <div id="pomodoro-display" aria-live="polite" aria-atomic="true">25:00</div>
    <div id="pomodoro-controls">
      <button id="pomodoro-start" aria-label="Start Pomodoro Timer"><i class="fas fa-play"></i></button>
      <button id="pomodoro-pause" aria-label="Pause Pomodoro Timer"><i class="fas fa-pause"></i></button>
      <button id="pomodoro-reset" aria-label="Reset Pomodoro Timer"><i class="fas fa-redo"></i></button>
    </div>
  </section>

  <!-- Settings Tab -->
  <section role="tabpanel" id="panel-settings" tabindex="0" aria-labelledby="tab-settings">
    <form id="settings-form" autocomplete="off" novalidate>
      <label for="input-bg-image">Background Image URL or Upload</label>
      <input type="text" id="input-bg-image" placeholder="Paste image URL here" />
      <input type="file" id="upload-bg-image" accept="image/*" aria-label="Upload background image" />
      <button type="button" id="bg-reposition-btn">Reposition Background</button>

      <div id="bg-reposition-container" hidden>
        <img id="bg-reposition-image" alt="Background to reposition" />
        <div id="bg-reposition-controls">
          <button type="button" id="bg-reposition-confirm">Confirm</button>
          <button type="button" id="bg-reposition-cancel">Cancel</button>
        </div>
      </div>

      <label for="color-text">Text Color (Hex or use color picker)</label>
      <input type="color" id="color-text" value="#FCF1F6" />
      <input type="text" id="hex-text" value="#FCF1F6" />

      <label for="color-title">Title Color</label>
      <input type="color" id="color-title" value="#AD1A72" />
      <input type="text" id="hex-title" value="#AD1A72" />

      <label for="color-outline">Outline Color</label>
      <input type="color" id="color-outline" value="#1a1a1a" />
      <input type="text" id="hex-outline" value="#1a1a1a" />

      <label for="color-input-bg">Input Background Color</label>
      <input type="color" id="color-input-bg" value="#222222" />
      <input type="text" id="hex-input-bg" value="#222222" />

      <label for="color-bg">Page Background Color</label>
      <input type="color" id="color-bg" value="#1a1a1a" />
      <input type="text" id="hex-bg" value="#1a1a1a" />

      <label for="alarm-upload">Upload Alarm Sound</label>
      <input type="file" id="alarm-upload" accept="audio/*" aria-label="Upload alarm sound" />
      <button type="button" id="alarm-reset">Reset Alarms to Default</button>

      <button type="submit" id="save-settings">Save Settings</button>
    </form>
  </section>

  <!-- Chat AI Tab -->
  <section role="tabpanel" id="panel-chat" tabindex="0" aria-labelledby="tab-chat">
    <div id="chat-container">
      <div id="chat-messages" role="log" aria-live="polite"></div>
      <div id="chat-input-container">
        <input
          type="text"
          id="chat-input"
          placeholder="Ask me anything..."
          aria-label="Chat input"
          autocomplete="off"
        />
        <button id="chat-send-btn" aria-label="Send chat message">Send</button>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  // STATE
  let theme = 'dark';

  // Tabs
  const tabs = [...document.querySelectorAll('nav#tabs button')];
  const panels = [...document.querySelectorAll('main section[role="tabpanel"]')];
  const appTitle = document.getElementById('app-title');
  const themeToggleBtn = document.getElementById('theme-toggle');

  function switchTab(selectedTabId) {
    tabs.forEach((tab) => {
      const selected = tab.id === selectedTabId;
      tab.setAttribute('aria-selected', selected);
      if (selected) tab.focus();
    });
    panels.forEach((panel) => {
      panel.classList.toggle('active', panel.id === 'panel-' + selectedTabId.slice(4));
    });
    // Change header title based on tab
    if (selectedTabId === 'tab-todo') {
      appTitle.textContent = '📝 To-Do List';
    } else if (selectedTabId === 'tab-countdown') {
      appTitle.textContent = countdownTitleInput.value || '🎀 Countdown 🎀';
    } else if (selectedTabId === 'tab-timers') {
      appTitle.textContent = timersTitleInput.value || '⏲️ Timers';
    } else if (selectedTabId === 'tab-stopwatch') {
      appTitle.textContent = '⏱️ Stopwatch';
    } else if (selectedTabId === 'tab-pomodoro') {
      appTitle.textContent = '🍅 Pomodoro';
    } else if (selectedTabId === 'tab-settings') {
      appTitle.textContent = '⚙️ Settings';
    } else if (selectedTabId === 'tab-chat') {
      appTitle.textContent = '🤖 Chat AI';
    }
  }
  tabs.forEach((tab) =>
    tab.addEventListener('click', () => switchTab(tab.id))
  );

  // Dark/Light theme toggle
  themeToggleBtn.addEventListener('click', () => {
    theme = theme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', theme);
  });

  // ------------- TO-DO LIST -------------

  const todoList = document.getElementById('todo-list');
  const todoInput = document.getElementById('todo-input');
  const todoToggleSubtask = document.getElementById('todo-toggle-subtask');
  const todoClearBtn = document.getElementById('todo-clear');

  // State
  let todos = JSON.parse(localStorage.getItem('todos') || '[]');
  let todoSubtaskMode = false;

  // Icons for bullet
  function bulletIcon(isSubtask, completed) {
    if (isSubtask) {
      return completed ? '<i class="fas fa-star star-fill"></i>' : '<i class="far fa-star star-outline"></i>';
    } else {
      return completed ? '<i class="fas fa-heart heart-fill"></i>' : '<i class="far fa-heart heart-outline"></i>';
    }
  }

  function saveTodos() {
    localStorage.setItem('todos', JSON.stringify(todos));
  }

  function renderTodos() {
    todoList.innerHTML = '';
    todos.forEach(({id, text, subtask, completed, due}, idx) => {
      const li = document.createElement('li');
      li.className = 'todo-item';
      li.setAttribute('draggable', 'true');
      li.setAttribute('data-id', id);

      // Bullet button
      const bulletBtn = document.createElement('button');
      bulletBtn.className = 'bullet';
      bulletBtn.innerHTML = bulletIcon(subtask, completed);
      bulletBtn.title = completed ? 'Mark incomplete' : 'Mark complete';
      bulletBtn.setAttribute('aria-label', bulletBtn.title);
      bulletBtn.addEventListener('click', () => {
        todos[idx].completed = !todos[idx].completed;
        saveTodos();
        renderTodos();
      });
      li.appendChild(bulletBtn);

      // Task text, contenteditable
      const taskText = document.createElement('div');
      taskText.className = 'todo-text';
      if (todos[idx].completed) taskText.classList.add('completed');
      taskText.setAttribute('contenteditable', 'true');
      taskText.textContent = text;
      taskText.setAttribute('aria-label', 'Task description');
      taskText.addEventListener('input', (e) => {
        todos[idx].text = e.target.textContent.trim();
        saveTodos();
      });
      li.appendChild(taskText);

      // Due date
      const dueDateSpan = document.createElement('span');
      dueDateSpan.className = 'due-date';
      if (due) {
        dueDateSpan.textContent = due;
        dueDateSpan.classList.remove('placeholder');
      } else {
        dueDateSpan.textContent = 'Add Due Date';
        dueDateSpan.classList.add('placeholder');
      }
      dueDateSpan.setAttribute('tabindex', '0');
      dueDateSpan.setAttribute('aria-label', due ? `Due date: ${due}` : 'Add due date');
      dueDateSpan.addEventListener('click', () => {
        showDueDatePicker(dueDateSpan, idx);
      });
      dueDateSpan.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          showDueDatePicker(dueDateSpan, idx);
        }
      });
      li.appendChild(dueDateSpan);

      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'close-btn';
      removeBtn.setAttribute('aria-label', 'Remove task');
      removeBtn.innerHTML = '<i class="fas fa-times"></i>';
      removeBtn.addEventListener('click', () => {
        todos.splice(idx, 1);
        saveTodos();
        renderTodos();
      });
      li.appendChild(removeBtn);

      todoList.appendChild(li);
    });
  }

  // Due date picker logic (inline)
  function showDueDatePicker(span, taskIndex) {
    // Replace span content with date input
    const input = document.createElement('input');
    input.type = 'date';
    input.value = todos[taskIndex].due || '';
    input.style.fontSize = '1rem';
    input.style.padding = '2px 5px';
    input.style.borderRadius = '6px';
    input.style.border = '1px solid var(--outline-dark)';
    input.style.backgroundColor = theme === 'dark' ? '#222' : '#eee';
    input.style.color = theme === 'dark' ? '#fcf1f6' : '#1a1a1a';

    span.innerHTML = '';
    span.appendChild(input);
    input.focus();

    function saveDate() {
      todos[taskIndex].due = input.value || null;
      saveTodos();
      renderTodos();
    }

    input.addEventListener('blur', saveDate);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        saveDate();
      } else if (e.key === 'Escape') {
        renderTodos();
      }
    });
  }

  todoToggleSubtask.addEventListener('click', () => {
    todoSubtaskMode = !todoSubtaskMode;
    todoToggleSubtask.setAttribute('aria-pressed', todoSubtaskMode);
    todoToggleSubtask.classList.toggle('active', todoSubtaskMode);
    if (todoSubtaskMode) {
      todoToggleSubtask.innerHTML = '<i class="far fa-star"></i>';
    } else {
      todoToggleSubtask.innerHTML = '<i class="far fa-heart"></i>';
    }
  });

  todoInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && todoInput.value.trim()) {
      e.preventDefault();
      addTodo(todoInput.value.trim(), todoSubtaskMode);
      todoInput.value = '';
    }
  });

  function addTodo(text, subtask = false) {
    todos.push({
      id: Date.now() + Math.random(),
      text,
      subtask,
      completed: false,
      due: null,
    });
    saveTodos();
    renderTodos();
    todoInput.focus();
  }

  todoClearBtn.addEventListener('click', () => {
    if (confirm('Clear all tasks? This cannot be undone.')) {
      todos = [];
      saveTodos();
      renderTodos();
    }
  });

  // Initially render todos
  renderTodos();

  // ------------- COUNTDOWNS -------------

  const countdownList = document.getElementById('countdown-list');
  const countdownAddBtn = document.getElementById('countdown-add');
  const countdownClearBtn = document.getElementById('countdown-clear');
  const countdownTitleInput = document.getElementById('countdown-title-input');

  let countdowns = JSON.parse(localStorage.getItem('countdowns') || '[]');

  countdownTitleInput.value = localStorage.getItem('countdownTitle') || '🎀 Countdown 🎀';

  function saveCountdowns() {
    localStorage.setItem('countdowns', JSON.stringify(countdowns));
  }

  function renderCountdowns() {
    countdownList.innerHTML = '';
    countdowns.forEach(({id, title, date}) => {
      const card = document.createElement('div');
      card.className = 'countdown-card';

      // Title editable
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.className = 'editable-title';
      titleInput.value = title;
      titleInput.setAttribute('aria-label', 'Countdown title');
      titleInput.addEventListener('input', () => {
        const idx = countdowns.findIndex(c => c.id === id);
        if (idx !== -1) {
          countdowns[idx].title = titleInput.value.trim() || '🎀 Countdown 🎀';
          saveCountdowns();
          if (document.activeElement !== titleInput) renderCountdowns();
        }
      });
      card.appendChild(titleInput);

      // Date input
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.value = date;
      dateInput.setAttribute('aria-label', 'Countdown target date');
      dateInput.addEventListener('change', () => {
        const idx = countdowns.findIndex(c => c.id === id);
        if (idx !== -1) {
          countdowns[idx].date = dateInput.value;
          saveCountdowns();
        }
      });
      card.appendChild(dateInput);

      // Countdown display
      const countdownDisplay = document.createElement('div');
      countdownDisplay.className = 'countdown-time';
      card.appendChild(countdownDisplay);

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn-timer';
      closeBtn.setAttribute('aria-label', 'Remove countdown');
      closeBtn.innerHTML = '<i class="fas fa-times"></i>';
      closeBtn.addEventListener('click', () => {
        countdowns = countdowns.filter(c => c.id !== id);
        saveCountdowns();
        renderCountdowns();
      });
      card.appendChild(closeBtn);

      countdownList.appendChild(card);

      // Update countdown display immediately and then every second
      function updateCountdown() {
        if (!dateInput.value) {
          countdownDisplay.textContent = 'Set date';
          return;
        }
        const targetDate = new Date(dateInput.value + 'T00:00:00');
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
          countdownDisplay.textContent = '🎉 Time reached!';
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        countdownDisplay.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);
    });
  }

  countdownAddBtn.addEventListener('click', () => {
    countdowns.push({
      id: Date.now() + Math.random(),
      title: '🎀 Countdown 🎀',
      date: ''
    });
    saveCountdowns();
    renderCountdowns();
  });

  countdownClearBtn.addEventListener('click', () => {
    if (confirm('Clear all countdowns?')) {
      countdowns = [];
      saveCountdowns();
      renderCountdowns();
    }
  });

  countdownTitleInput.addEventListener('input', () => {
    localStorage.setItem('countdownTitle', countdownTitleInput.value);
    if (document.activeElement !== countdownTitleInput) {
      appTitle.textContent = countdownTitleInput.value || '🎀 Countdown 🎀';
    }
  });

  // Initial render countdowns
  renderCountdowns();

  // ------------- TIMERS -------------

  const timerList = document.getElementById('timer-list');
  const timerAddBtn = document.getElementById('timer-add');
  const timerClearBtn = document.getElementById('timer-clear');
  const timersTitleInput = document.getElementById('timers-title-input');

  let timers = JSON.parse(localStorage.getItem('timers') || '[]');
  timersTitleInput.value = localStorage.getItem('timersTitle') || '⏲️ Timers';

  function saveTimers() {
    localStorage.setItem('timers', JSON.stringify(timers));
  }

  function renderTimers() {
    timerList.innerHTML = '';
    timers.forEach(({id, title, secondsLeft, running, totalSeconds}) => {
      const card = document.createElement('div');
      card.className = 'timer-card';

      // Title editable
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.className = 'editable-title';
      titleInput.value = title;
      titleInput.setAttribute('aria-label', 'Timer title');
      titleInput.addEventListener('input', () => {
        const idx = timers.findIndex(t => t.id === id);
        if (idx !== -1) {
          timers[idx].title = titleInput.value.trim() || '⏲️ Timer';
          saveTimers();
          if (document.activeElement !== titleInput) renderTimers();
        }
      });
      card.appendChild(titleInput);

      // Duration input (mm:ss)
      const durationInput = document.createElement('input');
      durationInput.type = 'time';
      durationInput.value = secondsToTimeString(totalSeconds || 0);
      durationInput.step = 1;
      durationInput.setAttribute('aria-label', 'Timer duration (HH:MM)');
      durationInput.addEventListener('change', () => {
        const idx = timers.findIndex(t => t.id === id);
        if (idx !== -1) {
          const [hh, mm, ss] = durationInput.value.split(':').map(Number);
          const newTotalSeconds = (hh || 0) * 3600 + (mm || 0) * 60 + (ss || 0);
          timers[idx].totalSeconds = newTotalSeconds;
          timers[idx].secondsLeft = newTotalSeconds;
          timers[idx].running = false;
          saveTimers();
          renderTimers();
        }
      });
      card.appendChild(durationInput);

      // Timer display
      const timerDisplay = document.createElement('div');
      timerDisplay.className = 'countdown-time';
      card.appendChild(timerDisplay);

      // Controls: start/pause/reset
      const controls = document.createElement('div');
      controls.className = 'timer-controls';

      const startBtn = document.createElement('button');
      startBtn.innerHTML = '<i class="fas fa-play"></i>';
      startBtn.title = 'Start Timer';
      startBtn.addEventListener('click', () => {
        const idx = timers.findIndex(t => t.id === id);
        if (idx !== -1) {
          timers[idx].running = true;
          saveTimers();
          renderTimers();
        }
      });
      controls.appendChild(startBtn);

      const pauseBtn = document.createElement('button');
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      pauseBtn.title = 'Pause Timer';
      pauseBtn.addEventListener('click', () => {
        const idx = timers.findIndex(t => t.id === id);
        if (idx !== -1) {
          timers[idx].running = false;
          saveTimers();
          renderTimers();
        }
      });
      controls.appendChild(pauseBtn);

      const resetBtn = document.createElement('button');
      resetBtn.innerHTML = '<i class="fas fa-redo"></i>';
      resetBtn.title = 'Reset Timer';
      resetBtn.addEventListener('click', () => {
        const idx = timers.findIndex(t => t.id === id);
        if (idx !== -1) {
          timers[idx].secondsLeft = timers[idx].totalSeconds;
          timers[idx].running = false;
          saveTimers();
          renderTimers();
        }
      });
      controls.appendChild(resetBtn);

      card.appendChild(controls);

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn-timer';
      closeBtn.setAttribute('aria-label', 'Remove timer');
      closeBtn.innerHTML = '<i class="fas fa-times"></i>';
      closeBtn.addEventListener('click', () => {
        timers = timers.filter(t => t.id !== id);
        saveTimers();
        renderTimers();
      });
      card.appendChild(closeBtn);

      timerList.appendChild(card);

      // Update display & countdown for this timer
      function updateTimer() {
        if (timers.find(t => t.id === id)?.running) {
          timers.forEach((t, i) => {
            if (t.id === id && t.secondsLeft > 0) {
              t.secondsLeft--;
              if (t.secondsLeft <= 0) {
                t.running = false;
                alert(`Timer "${t.title}" finished!`);
                playAlarm();
              }
            }
          });
          saveTimers();
          renderTimers();
        }
      }
      updateTimer();
      setInterval(() => {
        if (timers.find(t => t.id === id)?.running) updateTimer();
      }, 1000);

      // Set initial timer display
      timerDisplay.textContent = secondsToTimeString(secondsLeft || 0);
    });
  }

  function secondsToTimeString(totalSeconds) {
    const hh = Math.floor(totalSeconds / 3600);
    const mm = Math.floor((totalSeconds % 3600) / 60);
    const ss = totalSeconds % 60;
    if (hh > 0) {
      return `${padNum(hh)}:${padNum(mm)}:${padNum(ss)}`;
    }
    return `${padNum(mm)}:${padNum(ss)}`;
  }
  function padNum(num) {
    return num.toString().padStart(2, '0');
  }

  timerAddBtn.addEventListener('click', () => {
    timers.push({
      id: Date.now() + Math.random(),
      title: '⏲️ Timer',
      totalSeconds: 1500,
      secondsLeft: 1500,
      running: false,
    });
    saveTimers();
    renderTimers();
  });

  timerClearBtn.addEventListener('click', () => {
    if (confirm('Clear all timers?')) {
      timers = [];
      saveTimers();
      renderTimers();
    }
  });

  timersTitleInput.addEventListener('input', () => {
    localStorage.setItem('timersTitle', timersTitleInput.value);
    if (document.activeElement !== timersTitleInput) {
      appTitle.textContent = timersTitleInput.value || '⏲️ Timers';
    }
  });

  renderTimers();

  // ------------- STOPWATCH -------------

  const stopwatchDisplay = document.getElementById('stopwatch-display');
  const stopwatchStartBtn = document.getElementById('stopwatch-start');
  const stopwatchPauseBtn = document.getElementById('stopwatch-pause');
  const stopwatchResetBtn = document.getElementById('stopwatch-reset');
  const stopwatchPunchBtn = document.getElementById('stopwatch-punch');
  const punchesList = document.getElementById('punches-list');

  let stopwatchStartTime = null;
  let stopwatchElapsed = 0;
  let stopwatchRunning = false;
  let stopwatchTimerInterval = null;
  let punches = JSON.parse(localStorage.getItem('stopwatchPunches') || '[]');

  function formatStopwatchTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const centiseconds = Math.floor((ms % 1000) / 10);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    if (hours > 0) {
      return `${padNum(hours)}:${padNum(minutes)}:${padNum(seconds)}.${padNum(centiseconds)}`;
    }
    return `${padNum(minutes)}:${padNum(seconds)}.${padNum(centiseconds)}`;
  }

  function updateStopwatch() {
    if (!stopwatchRunning) return;
    const now = Date.now();
    stopwatchElapsed = now - stopwatchStartTime;
    stopwatchDisplay.textContent = formatStopwatchTime(stopwatchElapsed);
  }

  function startStopwatch() {
    if (!stopwatchRunning) {
      stopwatchStartTime = Date.now() - stopwatchElapsed;
      stopwatchRunning = true;
      stopwatchTimerInterval = setInterval(updateStopwatch, 10);
    }
  }
  function pauseStopwatch() {
    if (stopwatchRunning) {
      stopwatchRunning = false;
      clearInterval(stopwatchTimerInterval);
    }
  }
  function resetStopwatch() {
    stopwatchRunning = false;
    clearInterval(stopwatchTimerInterval);
    stopwatchElapsed = 0;
    stopwatchDisplay.textContent = formatStopwatchTime(stopwatchElapsed);
    punches = [];
    localStorage.setItem('stopwatchPunches', JSON.stringify(punches));
    renderPunches();
  }
  function punchStopwatch() {
    if (!stopwatchRunning) return;
    punches.push(formatStopwatchTime(stopwatchElapsed));
    localStorage.setItem('stopwatchPunches', JSON.stringify(punches));
    renderPunches();
  }
  function renderPunches() {
    punchesList.innerHTML = '';
    punches.forEach((time, idx) => {
      const li = document.createElement('li');
      li.textContent = `Punch ${idx + 1}: ${time}`;
      punchesList.appendChild(li);
    });
  }

  stopwatchStartBtn.addEventListener('click', startStopwatch);
  stopwatchPauseBtn.addEventListener('click', pauseStopwatch);
  stopwatchResetBtn.addEventListener('click', resetStopwatch);
  stopwatchPunchBtn.addEventListener('click', punchStopwatch);

  renderPunches();

  // ------------- POMODORO -------------

  const pomodoroDisplay = document.getElementById('pomodoro-display');
  const pomodoroStartBtn = document.getElementById('pomodoro-start');
  const pomodoroPauseBtn = document.getElementById('pomodoro-pause');
  const pomodoroResetBtn = document.getElementById('pomodoro-reset');

  let pomodoroDuration = 25 * 60; // 25 min default
  let pomodoroRemaining = pomodoroDuration;
  let pomodoroRunning = false;
  let pomodoroInterval = null;

  function formatPomodoroTime(seconds) {
    const mm = Math.floor(seconds / 60);
    const ss = seconds % 60;
    return `${padNum(mm)}:${padNum(ss)}`;
  }

  function updatePomodoro() {
    if (!pomodoroRunning) return;
    if (pomodoroRemaining > 0) {
      pomodoroRemaining--;
      pomodoroDisplay.textContent = formatPomodoroTime(pomodoroRemaining);
    } else {
      pomodoroRunning = false;
      clearInterval(pomodoroInterval);
      alert('Pomodoro complete! Take a break!');
      playAlarm();
    }
  }

  pomodoroStartBtn.addEventListener('click', () => {
    if (!pomodoroRunning) {
      pomodoroRunning = true;
      pomodoroInterval = setInterval(updatePomodoro, 1000);
    }
  });
  pomodoroPauseBtn.addEventListener('click', () => {
    if (pomodoroRunning) {
      pomodoroRunning = false;
      clearInterval(pomodoroInterval);
    }
  });
  pomodoroResetBtn.addEventListener('click', () => {
    pomodoroRunning = false;
    clearInterval(pomodoroInterval);
    pomodoroRemaining = pomodoroDuration;
    pomodoroDisplay.textContent = formatPomodoroTime(pomodoroRemaining);
  });
  pomodoroDisplay.textContent = formatPomodoroTime(pomodoroRemaining);

  // ------------- SETTINGS -------------

  const settingsForm = document.getElementById('settings-form');
  const inputBgImageURL = document.getElementById('input-bg-image');
  const uploadBgImageFile = document.getElementById('upload-bg-image');
  const bgRepositionBtn = document.getElementById('bg-reposition-btn');
  const bgRepositionContainer = document.getElementById('bg-reposition-container');
  const bgRepositionImage = document.getElementById('bg-reposition-image');
  const bgRepositionConfirmBtn = document.getElementById('bg-reposition-confirm');
  const bgRepositionCancelBtn = document.getElementById('bg-reposition-cancel');

  const colorTextInput = document.getElementById('color-text');
  const hexTextInput = document.getElementById('hex-text');
  const colorTitleInput = document.getElementById('color-title');
  const hexTitleInput = document.getElementById('hex-title');
  const colorOutlineInput = document.getElementById('color-outline');
  const hexOutlineInput = document.getElementById('hex-outline');
  const colorInputBgInput = document.getElementById('color-input-bg');
  const hexInputBgInput = document.getElementById('hex-input-bg');
  const colorBgInput = document.getElementById('color-bg');
  const hexBgInput = document.getElementById('hex-bg');

  const alarmUploadInput = document.getElementById('alarm-upload');
  const alarmResetBtn = document.getElementById('alarm-reset');

  let backgroundState = {
    url: '',
    posX: 50,
    posY: 50,
    scale: 1,
  };
  let isRepositioning = false;
  let dragStart = null;

  function applyBackground() {
    document.querySelector('main').style.backgroundImage = backgroundState.url ? `url('${backgroundState.url}')` : 'none';
    document.querySelector('main').style.backgroundPosition = `${backgroundState.posX}% ${backgroundState.posY}%`;
    document.querySelector('main').style.backgroundSize = `cover`;
  }

  function saveSettings() {
    localStorage.setItem('backgroundState', JSON.stringify(backgroundState));
    localStorage.setItem('textColor', colorTextInput.value);
    localStorage.setItem('titleColor', colorTitleInput.value);
    localStorage.setItem('outlineColor', colorOutlineInput.value);
    localStorage.setItem('inputBgColor', colorInputBgInput.value);
    localStorage.setItem('bgColor', colorBgInput.value);
  }

  function loadSettings() {
    const savedBackground = localStorage.getItem('backgroundState');
    if (savedBackground) {
      backgroundState = JSON.parse(savedBackground);
      applyBackground();
    }
    const savedTextColor = localStorage.getItem('textColor');
    if (savedTextColor) colorTextInput.value = savedTextColor;
    const savedTitleColor = localStorage.getItem('titleColor');
    if (savedTitleColor) colorTitleInput.value = savedTitleColor;
    const savedOutlineColor = localStorage.getItem('outlineColor');
    if (savedOutlineColor) colorOutlineInput.value = savedOutlineColor;
    const savedInputBgColor = localStorage.getItem('inputBgColor');
    if (savedInputBgColor) colorInputBgInput.value = savedInputBgColor;
    const savedBgColor = localStorage.getItem('bgColor');
    if (savedBgColor) colorBgInput.value = savedBgColor;

    // Apply colors
    document.documentElement.style.setProperty('--text-dark', colorTextInput.value);
    document.documentElement.style.setProperty('--title-dark', colorTitleInput.value);
    document.documentElement.style.setProperty('--outline-dark', colorOutlineInput.value);
    document.documentElement.style.setProperty('--input-bg-dark', colorInputBgInput.value);
    document.documentElement.style.setProperty('--bg-dark', colorBgInput.value);

    document.documentElement.style.setProperty('--text-light', colorTextInput.value);
    document.documentElement.style.setProperty('--title-light', colorTitleInput.value);
    document.documentElement.style.setProperty('--outline-light', colorOutlineInput.value);
    document.documentElement.style.setProperty('--input-bg-light', colorInputBgInput.value);
    document.documentElement.style.setProperty('--bg-light', colorBgInput.value);
  }

  loadSettings();

  bgRepositionBtn.addEventListener('click', () => {
    if (!backgroundState.url) return alert('No background image to reposition.');
    isRepositioning = true;
    bgRepositionContainer.hidden = false;
    bgRepositionImage.src = backgroundState.url;
    bgRepositionImage.style.objectPosition = `${backgroundState.posX}% ${backgroundState.posY}%`;
  });

  bgRepositionImage.addEventListener('mousedown', (e) => {
    if (!isRepositioning) return;
    dragStart = { x: e.clientX, y: e.clientY };
  });
  bgRepositionImage.addEventListener('mousemove', (e) => {
    if (!isRepositioning || !dragStart) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    backgroundState.posX = Math.min(100, Math.max(0, backgroundState.posX + dx / 5));
    backgroundState.posY = Math.min(100, Math.max(0, backgroundState.posY + dy / 5));
    bgRepositionImage.style.objectPosition = `${backgroundState.posX}% ${backgroundState.posY}%`;
    dragStart = { x: e.clientX, y: e.clientY };
  });
  bgRepositionImage.addEventListener('mouseup', () => {
    dragStart = null;
  });
  bgRepositionImage.addEventListener('mouseleave', () => {
    dragStart = null;
  });

  bgRepositionConfirmBtn.addEventListener('click', () => {
    isRepositioning = false;
    bgRepositionContainer.hidden = true;
    applyBackground();
    saveSettings();
  });
  bgRepositionCancelBtn.addEventListener('click', () => {
    isRepositioning = false;
    bgRepositionContainer.hidden = true;
  });

  inputBgImageURL.addEventListener('change', () => {
    backgroundState.url = inputBgImageURL.value;
    backgroundState.posX = 50;
    backgroundState.posY = 50;
    applyBackground();
    saveSettings();
  });

  uploadBgImageFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      backgroundState.url = evt.target.result;
      backgroundState.posX = 50;
      backgroundState.posY = 50;
      applyBackground();
      saveSettings();
      inputBgImageURL.value = '';
    };
    reader.readAsDataURL(file);
  });

  // Sync color hex inputs with color pickers
  function syncColorInputs(colorInput, hexInput) {
    colorInput.addEventListener('input', () => {
      hexInput.value = colorInput.value;
      applyColors();
      saveSettings();
    });
    hexInput.addEventListener('input', () => {
      if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
        colorInput.value = hexInput.value;
        applyColors();
        saveSettings();
      }
    });
  }

  function applyColors() {
    document.documentElement.style.setProperty('--text-dark', colorTextInput.value);
    document.documentElement.style.setProperty('--title-dark', colorTitleInput.value);
    document.documentElement.style.setProperty('--outline-dark', colorOutlineInput.value);
    document.documentElement.style.setProperty('--input-bg-dark', colorInputBgInput.value);
    document.documentElement.style.setProperty('--bg-dark', colorBgInput.value);

    document.documentElement.style.setProperty('--text-light', colorTextInput.value);
    document.documentElement.style.setProperty('--title-light', colorTitleInput.value);
    document.documentElement.style.setProperty('--outline-light', colorOutlineInput.value);
    document.documentElement.style.setProperty('--input-bg-light', colorInputBgInput.value);
    document.documentElement.style.setProperty('--bg-light', colorBgInput.value);
  }

  syncColorInputs(colorTextInput, hexTextInput);
  syncColorInputs(colorTitleInput, hexTitleInput);
  syncColorInputs(colorOutlineInput, hexOutlineInput);
  syncColorInputs(colorInputBgInput, hexInputBgInput);
  syncColorInputs(colorBgInput, hexBgInput);

  settingsForm.addEventListener('submit', (e) => {
    e.preventDefault();
    saveSettings();
    alert('Settings saved!');
  });

  // ------------- ALARM SOUND -------------

  const alarmAudio = new Audio();
  let defaultAlarmSrc = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';
  alarmAudio.src = localStorage.getItem('alarmSound') || defaultAlarmSrc;

  alarmUploadInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      alarmAudio.src = evt.target.result;
      localStorage.setItem('alarmSound', evt.target.result);
    };
    reader.readAsDataURL(file);
  });

  alarmResetBtn.addEventListener('click', () => {
    alarmAudio.src = defaultAlarmSrc;
    localStorage.removeItem('alarmSound');
    alert('Alarm sound reset to default.');
  });

  function playAlarm() {
    alarmAudio.play();
  }

  // ------------- CHAT AI -------------

  const chatContainer = document.getElementById('chat-container');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');

  function addChatMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message ' + (sender === 'user' ? 'user' : 'ai');
    msgDiv.setAttribute('role', 'article');
    msgDiv.setAttribute('aria-live', 'polite');
    const msgText = document.createElement('span');
    msgText.className = 'msg-text';
    msgText.textContent = text;
    msgDiv.appendChild(msgText);
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    addChatMessage(message, 'user');
    chatInput.value = '';
    chatInput.disabled = true;
    chatSendBtn.disabled = true;

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message})
      });
      const data = await response.json();
      if (data.response) {
        addChatMessage(data.response, 'ai');
      } else {
        addChatMessage('Error: No response from AI.', 'ai');
      }
    } catch (error) {
      addChatMessage('Error: ' + error.message, 'ai');
    } finally {
      chatInput.disabled = false;
      chatSendBtn.disabled = false;
      chatInput.focus();
    }
  }

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // Set initial tab
  switchTab('tab-todo');
})();
</script>
</body>
</html>
