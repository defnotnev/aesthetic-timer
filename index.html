<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultimate Notion Widget</title>
<style>
  :root {
    --title-color: #AD1A72;
    --text-color: #AD1A72;
    --outline-color: rgba(173, 26, 114, 0.15);
    --background-color-light: #fff;
    --background-color-dark: #1b1b1b;
    --background-blur: rgba(255 255 255 / 0.1);
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: var(--font-family);
    background: var(--background-color-light);
    color: var(--text-color);
    user-select: none;
    overflow: hidden;
  }

  body.dark {
    background: var(--background-color-dark);
    color: var(--text-color);
  }

  #app {
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    position: relative;
    overflow: hidden;
  }

  /* Background reposition container */
  #bg-reposition-container {
    display: none;
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  #bg-reposition-img {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    cursor: grab;
    user-select: none;
  }
  #bg-reposition-controls {
    margin-top: 10px;
    text-align: center;
  }
  #bg-reposition-controls button {
    margin: 0 8px;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: var(--title-color);
    color: white;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #bg-reposition-controls button:hover {
    background: #a0145c;
  }

  /* Tabs bar container */
  #tabs-bar {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    background-color: var(--outline-color);
    border-bottom: 1px solid var(--title-color);
    padding: 0.5rem 0;
    scrollbar-width: thin;
    z-index: 10;
  }
  #tabs-bar::-webkit-scrollbar {
    height: 6px;
  }
  #tabs-bar::-webkit-scrollbar-thumb {
    background-color: #AD1A72;
    border-radius: 3px;
  }
  #tabs-bar button {
    flex: 0 0 auto;
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    color: var(--title-color);
    font-weight: 700;
    font-size: 1rem;
    user-select: none;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: border-color 0.3s;
  }
  #tabs-bar button.active {
    border-color: #F472B6;
  }
  #tabs-bar button:hover {
    background-color: var(--outline-color);
  }

  /* Tab content container */
  #tab-content-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem 1.5rem;
    box-sizing: border-box;
    min-height: 0;
    position: relative;
    background: var(--background-blur);
    backdrop-filter: blur(6px);
    border-radius: 10px;
    margin: 0.5rem 1rem 1rem 1rem;
  }

  /* Tab panels */
  section[role="tabpanel"] {
    display: none;
  }
  section[role="tabpanel"].active {
    display: block;
  }

  /* Common button style */
  button {
    font-family: var(--font-family);
  }

  /* Inputs as chat bubbles */
  input[type=text], textarea {
    width: 100%;
    max-width: 100%;
    padding: 0.6rem 1rem;
    border-radius: 20px;
    border: 1.8px solid var(--outline-color);
    background: rgba(255 255 255 / 0.2);
    box-shadow: inset 0 0 6px rgba(0,0,0,0.07);
    color: var(--text-color);
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s ease, background 0.3s ease;
    font-weight: 600;
    user-select: text;
  }
  input[type=text]:focus, textarea:focus {
    border-color: var(--title-color);
    background: rgba(255 255 255 / 0.4);
    box-shadow: inset 0 0 8px var(--title-color);
  }

  /* Scrollbar for tab content */
  #tab-content-container::-webkit-scrollbar {
    width: 10px;
  }
  #tab-content-container::-webkit-scrollbar-thumb {
    background-color: var(--outline-color);
    border-radius: 5px;
  }

  /* To Do List Styles */
  #todo-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
    max-height: 300px;
    overflow-y: auto;
  }
  #todo-list li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255 255 255 / 0.12);
    margin-bottom: 6px;
    padding: 8px 12px;
    border-radius: 16px;
    cursor: grab;
    user-select: none;
    font-weight: 600;
  }
  #todo-list li.subtask {
    margin-left: 24px;
    font-style: italic;
    opacity: 0.85;
    font-weight: 500;
  }
  #todo-list li.completed {
    text-decoration: line-through;
    opacity: 0.5;
  }
  #todo-list li .bullet {
    flex-shrink: 0;
    cursor: pointer;
    font-size: 1.3rem;
    user-select: none;
    color: var(--title-color);
    transition: color 0.3s;
  }
  #todo-list li .bullet.filled {
    color: #F472B6;
  }
  #todo-list li:hover .remove-btn {
    opacity: 1;
  }
  .remove-btn {
    background: none;
    border: none;
    font-size: 1.4rem;
    color: #ee5c8d;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s;
    user-select: none;
  }

  /* To Do input container with icon toggle */
  #todo-input-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 0.5rem;
  }
  #todo-input-container button#task-type-toggle {
    border-radius: 50%;
    border: none;
    background: var(--outline-color);
    width: 38px;
    height: 38px;
    cursor: pointer;
    font-size: 1.4rem;
    color: var(--title-color);
    transition: background-color 0.3s ease;
  }
  #todo-input-container button#task-type-toggle:hover {
    background-color: #f4b0d2;
  }

  /* Music Interface */
  #music-now-playing {
    display: flex;
    align-items: center;
    background: rgba(255 255 255 / 0.2);
    padding: 8px 12px;
    border-radius: 12px;
    margin-bottom: 12px;
    user-select: none;
    font-weight: 600;
  }
  #music-now-playing img.cover-art {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 12px;
    box-shadow: 0 0 8px rgba(173, 26, 114, 0.8);
  }
  #music-now-playing .info {
    flex-grow: 1;
  }
  #music-now-playing .title {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--title-color);
  }
  #music-now-playing .duration {
    font-size: 0.9rem;
    opacity: 0.7;
  }
  #music-now-playing .progress-container {
    position: relative;
    width: 100%;
    margin-top: 6px;
  }
  #music-now-playing input[type=range] {
    width: 100%;
    -webkit-appearance: none;
    height: 6px;
    border-radius: 5px;
    background: var(--outline-color);
    cursor: pointer;
  }
  #music-now-playing input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--title-color);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 6px #AD1A72aa;
  }
  #music-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 8px;
  }
  #music-controls button {
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--title-color);
    user-select: none;
    transition: color 0.25s ease;
  }
  #music-controls button:hover {
    color: #F472B6;
  }

  /* Music Library */
  #music-library {
    max-height: 280px;
    overflow-y: auto;
    border-radius: 12px;
    background: rgba(255 255 255 / 0.12);
    padding: 10px;
    font-weight: 600;
    color: var(--title-color);
  }
  #music-library ul {
    list-style: none;
    margin: 0; padding: 0;
  }
  #music-library li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    border-radius: 14px;
    margin-bottom: 6px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.25s ease;
  }
  #music-library li:hover {
    background: #F472B633;
  }
  #music-library li .song-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #music-library li .song-info img {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    object-fit: cover;
    box-shadow: 0 0 8px rgba(173, 26, 114, 0.6);
  }
  #music-library li .song-info .name {
    font-weight: 600;
    color: var(--title-color);
  }
  #music-library li .queue-btn {
    background: none;
    border: none;
    color: var(--title-color);
    font-size: 1.2rem;
    cursor: pointer;
    user-select: none;
    margin-left: 12px;
    transition: color 0.3s ease;
  }
  #music-library li .queue-btn:hover {
    color: #F472B6;
  }
  #music-library li .remove-btn {
    background: none;
    border: none;
    color: #ee5c8d;
    font-size: 1.4rem;
    cursor: pointer;
    user-select: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    margin-left: 12px;
  }
  #music-library li:hover .remove-btn {
    opacity: 1;
  }

  /* Queue pane */
  #music-queue-container {
    margin-top: 10px;
    max-height: 180px;
    overflow-y: auto;
    background: rgba(255 255 255 / 0.12);
    border-radius: 10px;
    padding: 8px 12px;
    font-weight: 600;
    color: var(--title-color);
  }
  #music-queue-container.hidden {
    display: none;
  }
  #music-queue-container ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #music-queue-container li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 8px;
    border-radius: 12px;
    cursor: grab;
    user-select: none;
    transition: background-color 0.3s;
  }
  #music-queue-container li:hover {
    background: #F472B633;
  }
  #music-queue-container li .remove-btn {
    font-size: 1.2rem;
    color: #ee5c8d;
    cursor: pointer;
    user-select: none;
    margin-left: 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #music-queue-container li:hover .remove-btn {
    opacity: 1;
  }

  /* AI Chat */
  #ai-chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  #ai-messages {
    flex-grow: 1;
    overflow-y: auto;
    background: rgba(255 255 255 / 0.15);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
    color: var(--text-color);
    font-weight: 600;
  }
  .ai-message {
    margin-bottom: 12px;
    padding: 8px 14px;
    border-radius: 20px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .ai-message.user {
    background: #F472B6;
    color: white;
    margin-left: auto;
  }
  .ai-message.bot {
    background: var(--outline-color);
    color: var(--title-color);
  }
  #ai-input-container {
    display: flex;
    gap: 8px;
  }
  #ai-input {
    flex-grow: 1;
    border-radius: 20px;
    border: 1.5px solid var(--outline-color);
    padding: 0.7rem 1rem;
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-color);
    background: rgba(255 255 255 / 0.15);
    outline: none;
    transition: border-color 0.3s ease;
  }
  #ai-input:focus {
    border-color: var(--title-color);
  }
  #ai-send-btn {
    background: var(--title-color);
    border: none;
    color: white;
    padding: 0 18px;
    font-weight: 700;
    border-radius: 20px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #ai-send-btn:disabled {
    background: #e3a9be;
    cursor: default;
  }
  #ai-send-btn:hover:not(:disabled) {
    background: #9d125b;
  }

  /* Games */
  #games-list {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: center;
  }
  .game-card {
    width: 120px;
    height: 120px;
    border-radius: 14px;
    background: rgba(173, 26, 114, 0.15);
    color: var(--title-color);
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s ease;
    padding: 8px;
  }
  .game-card:hover {
    background: #F472B6;
    color: white;
  }
  #game-container {
    margin-top: 12px;
    border-radius: 12px;
    background: rgba(255 255 255 / 0.12);
    padding: 12px;
    min-height: 200px;
    user-select: none;
    color: var(--title-color);
  }
  #game-back-btn {
    margin-top: 10px;
    padding: 6px 14px;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    background: var(--title-color);
    color: white;
    cursor: pointer;
    user-select: none;
    display: none;
  }
  #game-back-btn:hover {
    background: #9d125b;
  }

  /* Settings */
  #settings-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #settings-panel label {
    font-weight: 700;
    color: var(--title-color);
  }
  #settings-panel input[type=text], #settings-panel input[type=color], #settings-panel select {
    width: 100%;
    padding: 0.4rem 0.8rem;
    border-radius: 14px;
    border: 1.5px solid var(--outline-color);
    background: rgba(255 255 255 / 0.15);
    color: var(--text-color);
    font-weight: 600;
    outline: none;
    transition: border-color 0.3s ease;
  }
  #settings-panel input[type=text]:focus, #settings-panel input[type=color]:focus, #settings-panel select:focus {
    border-color: var(--title-color);
  }
  #settings-panel button {
    margin-top: 0.5rem;
    font-weight: 700;
    padding: 0.5rem 1.2rem;
    border-radius: 14px;
    border: none;
    background: var(--title-color);
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #settings-panel button:hover {
    background: #9d125b;
  }

  /* Hide scrollbar for Chrome, Safari and Opera */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  /* Hide scrollbar for IE, Edge and Firefox */
  .no-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

  /* Light/Dark toggle switch style */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    background-color: var(--outline-color);
    border-radius: 24px;
    transition: 0.4s;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: var(--title-color);
    border-radius: 50%;
    transition: 0.4s;
  }
  input:checked + .slider {
    background-color: #F472B6;
  }
  input:checked + .slider:before {
    transform: translateX(22px);
    background-color: #AD1A72;
  }
  .switch-labels {
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    font-size: 0.8rem;
    color: var(--title-color);
    margin-top: 4px;
    user-select: none;
  }

  /* Hide file input */
  input[type="file"] {
    display: none;
  }

  /* Overlay plus button for music upload */
  #music-upload-btn {
    position: fixed;
    bottom: 14px;
    left: 14px;
    z-index: 20;
    background: var(--title-color);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    border: none;
    font-size: 2rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 0 12px var(--title-color);
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #music-upload-btn:hover {
    background-color: #9d125b;
  }

  /* Hide Now Playing queue */
  #queue-toggle-btn {
    background: none;
    border: none;
    font-weight: 700;
    color: var(--title-color);
    cursor: pointer;
    user-select: none;
    margin-left: auto;
    font-size: 1.1rem;
    transition: color 0.3s ease;
  }
  #queue-toggle-btn:hover {
    color: #F472B6;
  }

  /* Focus mode button top left */
  #focus-mode-btn {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 999;
    background: var(--title-color);
    border-radius: 18px;
    width: 36px;
    height: 36px;
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #focus-mode-btn:hover {
    background: #9d125b;
  }

  /* Responsive fixes for tabs and content */
  @media (max-width: 550px) {
    #tabs-bar button {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
    }
    #music-now-playing img.cover-art {
      width: 32px;
      height: 32px;
    }
  }

</style>
</head>
<body>
<div id="app" tabindex="0" aria-label="Ultimate Notion Widget">
  <button id="focus-mode-btn" aria-label="Toggle focus mode">⛶</button>
  <nav id="tabs-bar" role="tablist" aria-label="Widget Tabs">
    <button role="tab" id="tab-todo" aria-selected="true" aria-controls="panel-todo" tabindex="0">📝 To-Do List</button>
    <button role="tab" id="tab-timers" aria-selected="false" aria-controls="panel-timers" tabindex="-1">⏰ Timers</button>
    <button role="tab" id="tab-pomodoro" aria-selected="false" aria-controls="panel-pomodoro" tabindex="-1">🎀 Pomodoro</button>
    <button role="tab" id="tab-music" aria-selected="false" aria-controls="panel-music" tabindex="-1">🎵 Music</button>
    <button role="tab" id="tab-ai" aria-selected="false" aria-controls="panel-ai" tabindex="-1">🤖 AI Chat</button>
    <button role="tab" id="tab-games" aria-selected="false" aria-controls="panel-games" tabindex="-1">🎮 Games</button>
    <button role="tab" id="tab-settings" aria-selected="false" aria-controls="panel-settings" tabindex="-1">⚙️ Settings</button>
  </nav>

  <div id="tab-content-container">
    <!-- To-Do List -->
    <section role="tabpanel" id="panel-todo" aria-labelledby="tab-todo" class="active">
      <ul id="todo-list" aria-live="polite" aria-relevant="additions removals"></ul>
      <div id="todo-input-container">
        <button id="task-type-toggle" title="Toggle Task Type" aria-label="Toggle between main task and subtask">❤️</button>
        <input type="text" id="todo-input" placeholder="Add a task and press Enter..." aria-label="Add a new task" autocomplete="off" />
      </div>
      <button id="clear-tasks-btn" aria-label="Clear all tasks">Clear All Tasks</button>
    </section>

    <!-- Timers -->
    <section role="tabpanel" id="panel-timers" aria-labelledby="tab-timers">
      <div id="timers-container"></div>
      <button id="add-timer-btn">+ Add Timer</button>
      <button id="clear-timers-btn">Reset All Timers</button>
    </section>

    <!-- Pomodoro -->
    <section role="tabpanel" id="panel-pomodoro" aria-labelledby="tab-pomodoro">
      <div id="pomodoro-timer">
        <h3>Pomodoro Timer</h3>
        <div id="pomodoro-display">25:00</div>
        <button id="pomodoro-start">Start</button>
        <button id="pomodoro-pause">Pause</button>
        <button id="pomodoro-reset">Reset</button>
      </div>
    </section>

    <!-- Music -->
    <section role="tabpanel" id="panel-music" aria-labelledby="tab-music">
      <div id="music-now-playing" aria-live="polite" aria-atomic="true">
        <img class="cover-art" src="" alt="Cover Art" />
        <div class="info">
          <div class="title">No music playing</div>
          <div class="duration">00:00</div>
          <div class="progress-container">
            <input type="range" id="music-progress" min="0" max="100" value="0" step="1" aria-label="Music progress slider" />
          </div>
        </div>
        <button id="queue-toggle-btn" aria-label="Toggle queue visibility">Show Queue ▼</button>
      </div>
      <div id="music-controls">
        <button id="prev-song-btn" title="Previous Song" aria-label="Previous Song">⏮️</button>
        <button id="play-pause-btn" title="Play/Pause" aria-label="Play or Pause">▶️</button>
        <button id="next-song-btn" title="Next Song" aria-label="Next Song">⏭️</button>
        <button id="shuffle-btn" title="Shuffle" aria-label="Toggle Shuffle">🔀</button>
        <button id="repeat-btn" title="Repeat Mode" aria-label="Cycle Repeat Mode">🔁</button>
      </div>
      <div id="music-library">
        <ul id="music-list"></ul>
      </div>
      <div id="music-queue-container" class="hidden" aria-live="polite" aria-atomic="true">
        <h4>Up Next:</h4>
        <ul id="music-queue-list"></ul>
      </div>
      <button id="music-upload-btn" title="Upload Audio" aria-label="Upload audio file">+</button>
      <input type="file" id="music-upload-file" accept="audio/*" aria-hidden="true" />
      <button id="music-upload-url-btn" aria-label="Upload audio from URL">Upload URL</button>
      <input type="text" id="music-upload-url-input" placeholder="Enter audio URL here" style="display:none;" aria-label="Audio URL input" />
    </section>

    <!-- AI Chat -->
    <section role="tabpanel" id="panel-ai" aria-labelledby="tab-ai">
      <div id="ai-chat-container">
        <div id="ai-messages" role="log" aria-live="polite" aria-relevant="additions"></div>
        <div id="ai-input-container">
          <input type="text" id="ai-input" placeholder="Ask me anything..." aria-label="AI chat input" autocomplete="off" />
          <button id="ai-send-btn" aria-label="Send message" disabled>Send</button>
        </div>
      </div>
    </section>

    <!-- Games -->
    <section role="tabpanel" id="panel-games" aria-labelledby="tab-games">
      <div id="games-list">
        <div class="game-card" data-game="memory">🧠 Memory</div>
        <div class="game-card" data-game="snake">🐍 Snake</div>
        <div class="game-card" data-game="tictactoe">❌ Tic Tac Toe</div>
      </div>
      <div id="game-container" aria-live="polite" aria-atomic="true"></div>
      <button id="game-back-btn" aria-label="Back to game list">Back</button>
    </section>

    <!-- Settings -->
    <section role="tabpanel" id="panel-settings" aria-labelledby="tab-settings">
      <div id="settings-panel">
        <label for="title-color-picker">Title Color:</label>
        <input type="color" id="title-color-picker" value="#AD1A72" />
        <label for="text-color-picker">Default Text Color:</label>
        <input type="color" id="text-color-picker" value="#AD1A72" />
        <label for="outline-color-picker">Outline Block Color:</label>
        <input type="color" id="outline-color-picker" value="#d692b4" />
        <label for="background-upload">Upload Background Image:</label>
        <input type="file" id="background-upload" accept="image/*" />
        <button id="bg-reposition-btn">Reposition Background</button>
        <label for="widget-width">Custom Widget Width (px):</label>
        <input type="number" id="widget-width" min="300" max="1920" placeholder="e.g. 800" />
        <label for="widget-height">Custom Widget Height (px):</label>
        <input type="number" id="widget-height" min="300" max="1080" placeholder="e.g. 600" />
        <label for="orientation-select">Orientation:</label>
        <select id="orientation-select">
          <option value="landscape" selected>Landscape</option>
          <option value="portrait">Portrait</option>
        </select>

        <div style="margin-top:1rem;">
          <label>Light / Dark Mode</label>
          <div class="switch">
            <input type="checkbox" id="dark-mode-toggle" />
            <span class="slider"></span>
          </div>
          <div class="switch-labels">
            <span>Light ☀️</span><span>Dark 🌙</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Background reposition modal -->
  <div id="bg-reposition-container" role="dialog" aria-modal="true" aria-labelledby="bg-reposition-title">
    <div>
      <img id="bg-reposition-img" src="" alt="Background reposition image" />
      <div id="bg-reposition-controls">
        <button id="bg-reposition-confirm">Confirm</button>
        <button id="bg-reposition-cancel">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // UTILITIES
  function createElement(type, props = {}, ...children) {
    const el = document.createElement(type);
    for (const key in props) {
      if (key.startsWith('on') && typeof props[key] === 'function') {
        el.addEventListener(key.substring(2).toLowerCase(), props[key]);
      } else if (key === 'style' && typeof props[key] === 'object') {
        Object.assign(el.style, props[key]);
      } else {
        el.setAttribute(key, props[key]);
      }
    }
    for (const child of children) {
      if (typeof child === 'string') {
        el.appendChild(document.createTextNode(child));
      } else if (child instanceof Node) {
        el.appendChild(child);
      }
    }
    return el;
  }

  // APP STATE
  const state = {
    activeTab: 'todo',
    focusMode: false,
    tasks: JSON.parse(localStorage.getItem('tasks') || '[]'),
    taskType: 'main', // main or subtask
    timers: JSON.parse(localStorage.getItem('timers') || '[]'),
    pomodoro: {
      duration: 25 * 60,
      remaining: 25 * 60,
      running: false,
      intervalId: null,
    },
    music: {
      library: JSON.parse(localStorage.getItem('music-library') || '[]'),
      queue: JSON.parse(localStorage.getItem('music-queue') || '[]'),
      nowPlayingIndex: -1,
      audioElement: new Audio(),
      shuffle: false,
      repeatMode: 'none', // none, one, all
      isPlaying: false,
    },
    ai: {
      history: [],
    },
    settings: {
      titleColor: '#AD1A72',
      textColor: '#AD1A72',
      outlineColor: 'rgba(215, 140, 180, 0.2)',
      backgroundImage: '',
      widgetWidth: '',
      widgetHeight: '',
      orientation: 'landscape',
      darkMode: false,
      backgroundPosition: { x: 50, y: 50, scale: 1 },
    },
    game: {
      currentGame: null,
    }
  };

  // ELEMENTS
  const tabsBar = document.getElementById('tabs-bar');
  const tabButtons = tabsBar.querySelectorAll('button[role="tab"]');
  const tabContentContainer = document.getElementById('tab-content-container');

  // ToDo Elements
  const todoList = document.getElementById('todo-list');
  const todoInput = document.getElementById('todo-input');
  const taskTypeToggle = document.getElementById('task-type-toggle');
  const clearTasksBtn = document.getElementById('clear-tasks-btn');

  // Timer Elements
  const timersContainer = document.getElementById('timers-container');
  const addTimerBtn = document.getElementById('add-timer-btn');
  const clearTimersBtn = document.getElementById('clear-timers-btn');

  // Pomodoro Elements
  const pomodoroDisplay = document.getElementById('pomodoro-display');
  const pomodoroStartBtn = document.getElementById('pomodoro-start');
  const pomodoroPauseBtn = document.getElementById('pomodoro-pause');
  const pomodoroResetBtn = document.getElementById('pomodoro-reset');

  // Music Elements
  const musicNowPlaying = document.getElementById('music-now-playing');
  const musicCoverArt = musicNowPlaying.querySelector('.cover-art');
  const musicTitle = musicNowPlaying.querySelector('.title');
  const musicDuration = musicNowPlaying.querySelector('.duration');
  const musicProgress = document.getElementById('music-progress');
  const queueToggleBtn = document.getElementById('queue-toggle-btn');
  const musicList = document.getElementById('music-list');
  const musicQueueContainer = document.getElementById('music-queue-container');
  const musicQueueList = document.getElementById('music-queue-list');
  const musicUploadBtn = document.getElementById('music-upload-btn');
  const musicUploadFile = document.getElementById('music-upload-file');
  const musicUploadUrlBtn = document.getElementById('music-upload-url-btn');
  const musicUploadUrlInput = document.getElementById('music-upload-url-input');
  const prevSongBtn = document.getElementById('prev-song-btn');
  const playPauseBtn = document.getElementById('play-pause-btn');
  const nextSongBtn = document.getElementById('next-song-btn');
  const shuffleBtn = document.getElementById('shuffle-btn');
  const repeatBtn = document.getElementById('repeat-btn');

  // AI Elements
  const aiMessages = document.getElementById('ai-messages');
  const aiInput = document.getElementById('ai-input');
  const aiSendBtn = document.getElementById('ai-send-btn');

  // Games Elements
  const gamesList = document.getElementById('games-list');
  const gameContainer = document.getElementById('game-container');
  const gameBackBtn = document.getElementById('game-back-btn');

  // Settings Elements
  const titleColorPicker = document.getElementById('title-color-picker');
  const textColorPicker = document.getElementById('text-color-picker');
  const outlineColorPicker = document.getElementById('outline-color-picker');
  const backgroundUpload = document.getElementById('background-upload');
  const bgRepositionBtn = document.getElementById('bg-reposition-btn');
  const widgetWidthInput = document.getElementById('widget-width');
  const widgetHeightInput = document.getElementById('widget-height');
  const orientationSelect = document.getElementById('orientation-select');
  const darkModeToggle = document.getElementById('dark-mode-toggle');

  const bgRepositionContainer = document.getElementById('bg-reposition-container');
  const bgRepositionImg = document.getElementById('bg-reposition-img');
  const bgRepositionConfirm = document.getElementById('bg-reposition-confirm');
  const bgRepositionCancel = document.getElementById('bg-reposition-cancel');

  // Focus mode button
  const focusModeBtn = document.getElementById('focus-mode-btn');

  // Helper: save to local storage
  function saveToStorage() {
    localStorage.setItem('tasks', JSON.stringify(state.tasks));
    localStorage.setItem('timers', JSON.stringify(state.timers));
    localStorage.setItem('music-library', JSON.stringify(state.music.library));
    localStorage.setItem('music-queue', JSON.stringify(state.music.queue));
    localStorage.setItem('settings', JSON.stringify(state.settings));
  }

  // Initialize settings from localStorage
  function loadSettings() {
    const saved = localStorage.getItem('settings');
    if (saved) {
      Object.assign(state.settings, JSON.parse(saved));
    }
    document.documentElement.style.setProperty('--title-color', state.settings.titleColor);
    document.documentElement.style.setProperty('--text-color', state.settings.textColor);
    document.documentElement.style.setProperty('--outline-color', state.settings.outlineColor);

    titleColorPicker.value = state.settings.titleColor;
    textColorPicker.value = state.settings.textColor;
    outlineColorPicker.value = state.settings.outlineColor;

    if (state.settings.backgroundImage) {
      setBackgroundImage(state.settings.backgroundImage);
    }
    if (state.settings.widgetWidth) {
      resizeWidget(state.settings.widgetWidth, state.settings.widgetHeight);
      widgetWidthInput.value = state.settings.widgetWidth;
      widgetHeightInput.value = state.settings.widgetHeight;
    }
    if (state.settings.orientation) {
      orientationSelect.value = state.settings.orientation;
    }
    darkModeToggle.checked = state.settings.darkMode;
    updateDarkMode(state.settings.darkMode);
  }

  // Set background image and style for repositioning
  function setBackgroundImage(src) {
    state.settings.backgroundImage = src;
    const app = document.getElementById('app');
    app.style.backgroundImage = `url(${src})`;
    // Reset background position on new image
    app.style.backgroundPosition = `${state.settings.backgroundPosition.x}% ${state.settings.backgroundPosition.y}%`;
    app.style.backgroundSize = state.settings.orientation === 'portrait' ? 'auto 100%' : '100% auto';
    saveToStorage();
  }

  // Resize widget container with orientation consideration
  function resizeWidget(width, height) {
    const app = document.getElementById('app');
    if (width) app.style.width = width + 'px';
    else app.style.width = '';
    if (height) app.style.height = height + 'px';
    else app.style.height = '';
  }

  // Dark mode toggle
  function updateDarkMode(isDark) {
    if (isDark) {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
  }

  // Tabs management
  function switchTab(newTabId) {
    if (state.activeTab === newTabId) return;
    state.activeTab = newTabId;
    tabButtons.forEach(btn => {
      const isActive = btn.id === `tab-${newTabId}`;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-selected', isActive);
      btn.tabIndex = isActive ? 0 : -1;
    });
    const tabPanels = tabContentContainer.querySelectorAll('[role="tabpanel"]');
    tabPanels.forEach(panel => {
      panel.classList.toggle('active', panel.id === `panel-${newTabId}`);
    });
  }

  // TODO LIST FUNCTIONS
  function renderTasks() {
    todoList.innerHTML = '';
    state.tasks.forEach((task, i) => {
      const li = createElement('li', {
        draggable: 'true',
        'aria-label': (task.completed ? 'Completed task: ' : 'Task: ') + task.text,
        role: 'listitem',
        tabIndex: 0,
        'data-index': i,
        class: (task.completed ? 'completed' : '') + (task.type === 'subtask' ? ' subtask' : ''),
      });

      // Bullet for marking completed
      const bullet = createElement('span', {
        class: 'bullet' + (task.completed ? ' filled' : ''),
        role: 'checkbox',
        'aria-checked': task.completed,
        tabindex: 0,
        title: 'Mark task completed',
        onClick: () => toggleTaskCompletion(i),
        onKeyDown: e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTaskCompletion(i); } }
      }, task.completed ? '✔️' : '⬜');

      // Task text
      const textSpan = createElement('span', {}, task.text);

      // Remove button, hidden unless hover or focus
      const removeBtn = createElement('button', {
        class: 'remove-btn',
        title: 'Remove Task',
        ariaLabel: 'Remove task',
        onClick: () => removeTask(i),
        tabIndex: 0,
      }, '✖️');

      li.appendChild(bullet);
      li.appendChild(textSpan);
      li.appendChild(removeBtn);

      todoList.appendChild(li);
    });
  }

  function toggleTaskCompletion(index) {
    state.tasks[index].completed = !state.tasks[index].completed;
    saveToStorage();
    renderTasks();
  }

  function removeTask(index) {
    state.tasks.splice(index, 1);
    saveToStorage();
    renderTasks();
  }

  function addTask(text, type = 'main') {
    if (!text.trim()) return;
    state.tasks.push({ text: text.trim(), completed: false, type });
    saveToStorage();
    renderTasks();
  }

  // Timer Functions (simplified)
  function renderTimers() {
    timersContainer.innerHTML = '';
    if (state.timers.length === 0) {
      timersContainer.textContent = 'No timers set.';
      return;
    }
    state.timers.forEach((timer, i) => {
      const div = createElement('div', {
        style: {
          background: 'rgba(173, 26, 114, 0.15)',
          padding: '8px 12px',
          borderRadius: '14px',
          marginBottom: '8px',
          fontWeight: '600',
          color: 'var(--title-color)',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
        },
      });
      const label = createElement('span', {}, timer.label);
      const time = createElement('span', {}, formatSeconds(timer.remaining));

      // Controls: start/stop/reset
      const btnStart = createElement('button', { title: 'Start Timer' }, '▶️');
      const btnPause = createElement('button', { title: 'Pause Timer' }, '⏸️');
      const btnReset = createElement('button', { title: 'Reset Timer' }, '🔄');
      btnStart.onclick = () => startTimer(i);
      btnPause.onclick = () => pauseTimer(i);
      btnReset.onclick = () => resetTimer(i);

      const controls = createElement('div', {}, btnStart, btnPause, btnReset);
      controls.style.display = 'flex';
      controls.style.gap = '6px';

      div.appendChild(label);
      div.appendChild(time);
      div.appendChild(controls);

      timersContainer.appendChild(div);
    });
  }

  function formatSeconds(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  function addTimer() {
    const label = prompt('Enter timer label/name:', 'New Timer');
    if (!label) return;
    state.timers.push({ label, duration: 300, remaining: 300, running: false, intervalId: null });
    saveToStorage();
    renderTimers();
  }

  function startTimer(index) {
    const timer = state.timers[index];
    if (timer.running) return;
    timer.running = true;
    timer.intervalId = setInterval(() => {
      if (timer.remaining > 0) {
        timer.remaining--;
        saveToStorage();
        renderTimers();
      } else {
        clearInterval(timer.intervalId);
        timer.running = false;
        alert(`Timer "${timer.label}" finished!`);
        saveToStorage();
        renderTimers();
      }
    }, 1000);
  }
  function pauseTimer(index) {
    const timer = state.timers[index];
    if (!timer.running) return;
    timer.running = false;
    clearInterval(timer.intervalId);
    saveToStorage();
    renderTimers();
  }
  function resetTimer(index) {
    const timer = state.timers[index];
    timer.remaining = timer.duration;
    if (timer.running) {
      clearInterval(timer.intervalId);
      timer.running = false;
    }
    saveToStorage();
    renderTimers();
  }

  // Clear timers
  function resetAllTimers() {
    state.timers.forEach(t => {
      t.remaining = t.duration;
      t.running = false;
      clearInterval(t.intervalId);
    });
    saveToStorage();
    renderTimers();
  }

  // Pomodoro Functions
  function updatePomodoroDisplay() {
    const m = Math.floor(state.pomodoro.remaining / 60).toString().padStart(2, '0');
    const s = (state.pomodoro.remaining % 60).toString().padStart(2, '0');
    pomodoroDisplay.textContent = `${m}:${s}`;
  }

  function pomodoroTick() {
    if (state.pomodoro.remaining > 0) {
      state.pomodoro.remaining--;
      updatePomodoroDisplay();
    } else {
      clearInterval(state.pomodoro.intervalId);
      state.pomodoro.running = false;
      alert("Pomodoro finished! Time for a break.");
      updatePomodoroDisplay();
    }
  }

  function startPomodoro() {
    if (state.pomodoro.running) return;
    state.pomodoro.running = true;
    state.pomodoro.intervalId = setInterval(pomodoroTick, 1000);
  }
  function pausePomodoro() {
    if (!state.pomodoro.running) return;
    state.pomodoro.running = false;
    clearInterval(state.pomodoro.intervalId);
  }
  function resetPomodoro() {
    pausePomodoro();
    state.pomodoro.remaining = state.pomodoro.duration;
    updatePomodoroDisplay();
  }

  // MUSIC FUNCTIONS

  function renderMusicLibrary() {
    musicList.innerHTML = '';
    if (state.music.library.length === 0) {
      musicList.textContent = 'No songs in library.';
      return;
    }
    state.music.library.forEach((song, i) => {
      const li = createElement('li', { tabindex: 0, role: 'button', 'data-index': i, 'aria-label': `Play or queue song ${song.name}` });

      const songInfo = createElement('div', { class: 'song-info' });
      const img = createElement('img', { src: song.cover || '', alt: `${song.name} cover art`, loading: 'lazy' });
      const name = createElement('span', { class: 'name' }, song.name);

      songInfo.appendChild(img);
      songInfo.appendChild(name);

      const queueBtn = createElement('button', { class: 'queue-btn', title: 'Add to Queue' }, '➕');
      queueBtn.onclick = e => {
        e.stopPropagation();
        addSongToQueue(i);
      };

      const removeBtn = createElement('button', { class: 'remove-btn', title: 'Remove from Library' }, '✖️');
      removeBtn.onclick = e => {
        e.stopPropagation();
        removeSongFromLibrary(i);
      };

      li.appendChild(songInfo);
      li.appendChild(queueBtn);
      li.appendChild(removeBtn);

      li.onclick = () => {
        playSong(i);
      };

      musicList.appendChild(li);
    });
  }

  function renderMusicNowPlaying() {
    if (state.music.nowPlayingIndex === -1) {
      musicCoverArt.src = '';
      musicTitle.textContent = 'No music playing';
      musicDuration.textContent = '00:00';
      musicProgress.value = 0;
      playPauseBtn.textContent = '▶️';
      return;
    }
    const song = state.music.library[state.music.nowPlayingIndex];
    if (!song) return;
    musicCoverArt.src = song.cover || '';
    musicTitle.textContent = song.name;
    const duration = state.music.audioElement.duration || 0;
    musicDuration.textContent = formatSeconds(Math.floor(duration));
    playPauseBtn.textContent = state.music.isPlaying ? '⏸️' : '▶️';
  }

  function playSong(index) {
    if (index < 0 || index >= state.music.library.length) return;
    state.music.nowPlayingIndex = index;
    const song = state.music.library[index];
    state.music.audioElement.src = song.url;
    state.music.audioElement.play();
    state.music.isPlaying = true;
    renderMusicNowPlaying();
    saveToStorage();
  }

  function togglePlayPause() {
    if (state.music.audioElement.paused) {
      state.music.audioElement.play();
      state.music.isPlaying = true;
      playPauseBtn.textContent = '⏸️';
    } else {
      state.music.audioElement.pause();
      state.music.isPlaying = false;
      playPauseBtn.textContent = '▶️';
    }
  }

  function playNextSong() {
    if (state.music.shuffle) {
      const randIndex = Math.floor(Math.random() * state.music.library.length);
      playSong(randIndex);
      return;
    }
    if (state.music.nowPlayingIndex === -1) {
      if (state.music.library.length > 0) playSong(0);
      return;
    }
    if (state.music.repeatMode === 'one') {
      // Repeat current
      playSong(state.music.nowPlayingIndex);
      return;
    }
    if (state.music.nowPlayingIndex < state.music.library.length - 1) {
      playSong(state.music.nowPlayingIndex + 1);
    } else {
      if (state.music.repeatMode === 'all') {
        playSong(0);
      } else {
        // Stop playback
        state.music.audioElement.pause();
        state.music.isPlaying = false;
        playPauseBtn.textContent = '▶️';
      }
    }
  }

  function playPrevSong() {
    if (state.music.nowPlayingIndex > 0) {
      playSong(state.music.nowPlayingIndex - 1);
    } else {
      playSong(state.music.library.length - 1);
    }
  }

  function addSongToQueue(index) {
    if (index < 0 || index >= state.music.library.length) return;
    const song = state.music.library[index];
    state.music.queue.push(song);
    saveToStorage();
    renderQueue();
  }

  function removeSongFromLibrary(index) {
    if (index < 0 || index >= state.music.library.length) return;
    if (confirm(`Remove "${state.music.library[index].name}" from library?`)) {
      state.music.library.splice(index, 1);
      // Fix nowPlayingIndex if necessary
      if (state.music.nowPlayingIndex === index) {
        state.music.nowPlayingIndex = -1;
        state.music.audioElement.pause();
        state.music.isPlaying = false;
      } else if (state.music.nowPlayingIndex > index) {
        state.music.nowPlayingIndex--;
      }
      saveToStorage();
      renderMusicLibrary();
      renderMusicNowPlaying();
    }
  }

  function renderQueue() {
    musicQueueList.innerHTML = '';
    if (state.music.queue.length === 0) {
      musicQueueList.textContent = '(Queue is empty)';
      return;
    }
    state.music.queue.forEach((song, i) => {
      const li = createElement('li', {}, song.name);
      const removeBtn = createElement('button', { class: 'remove-btn', title: 'Remove from Queue' }, '✖️');
      removeBtn.onclick = e => {
        e.stopPropagation();
        state.music.queue.splice(i, 1);
        saveToStorage();
        renderQueue();
      };
      li.appendChild(removeBtn);
      musicQueueList.appendChild(li);
    });
  }

  // Music progress update handler
  function updateMusicProgress() {
    const currentTime = state.music.audioElement.currentTime;
    const duration = state.music.audioElement.duration || 0;
    if (duration > 0) {
      const percent = (currentTime / duration) * 100;
      musicProgress.value = percent;
      musicDuration.textContent = `${formatSeconds(Math.floor(currentTime))} / ${formatSeconds(Math.floor(duration))}`;
    }
  }

  // Seek music on progress bar change
  musicProgress.addEventListener('input', () => {
    const duration = state.music.audioElement.duration || 0;
    if (duration > 0) {
      const seekTime = (musicProgress.value / 100) * duration;
      state.music.audioElement.currentTime = seekTime;
    }
  });

  // Music Upload Handlers
  musicUploadBtn.onclick = () => {
    musicUploadFile.click();
  };
  musicUploadFile.onchange = () => {
    const files = musicUploadFile.files;
    if (files.length === 0) return;
    const file = files[0];
    const url = URL.createObjectURL(file);
    const name = file.name;
    const cover = ''; // Could implement cover extraction later
    state.music.library.push({ name, url, cover });
    saveToStorage();
    renderMusicLibrary();
    musicUploadFile.value = '';
  };

  musicUploadUrlBtn.onclick = () => {
    if (musicUploadUrlInput.style.display === 'none') {
      musicUploadUrlInput.style.display = 'block';
      musicUploadUrlInput.focus();
      musicUploadUrlBtn.textContent = 'Submit URL';
    } else {
      const url = musicUploadUrlInput.value.trim();
      if (!url) {
        alert('Please enter a valid audio URL.');
        return;
      }
      const name = url.split('/').pop() || 'Untitled';
      state.music.library.push({ name, url, cover: '' });
      saveToStorage();
      renderMusicLibrary();
      musicUploadUrlInput.value = '';
      musicUploadUrlInput.style.display = 'none';
      musicUploadUrlBtn.textContent = 'Upload URL';
    }
  };

  // Audio event listeners
  state.music.audioElement.addEventListener('timeupdate', updateMusicProgress);
  state.music.audioElement.addEventListener('ended', playNextSong);

  // Play/pause, next, prev buttons
  playPauseBtn.onclick = togglePlayPause;
  nextSongBtn.onclick = playNextSong;
  prevSongBtn.onclick = playPrevSong;

  // Shuffle and repeat
  shuffleBtn.onclick = () => {
    state.music.shuffle = !state.music.shuffle;
    shuffleBtn.style.color = state.music.shuffle ? '#AD1A72' : 'var(--title-color)';
  };
  repeatBtn.onclick = () => {
    const modes = ['none', 'one', 'all'];
    const currentIndex = modes.indexOf(state.music.repeatMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    state.music.repeatMode = modes[nextIndex];
    repeatBtn.textContent = state.music.repeatMode === 'none' ? '🔁' : state.music.repeatMode === 'one' ? '🔂' : '🔁⬜';
  };

  // AI Chat Handlers
  function renderAIMessages() {
    aiMessages.innerHTML = '';
    state.ai.history.forEach(msg => {
      const div = createElement('div', { class: msg.from === 'user' ? 'ai-msg user' : 'ai-msg bot' }, msg.text);
      aiMessages.appendChild(div);
    });
    aiMessages.scrollTop = aiMessages.scrollHeight;
  }

  function addAIMessage(text, from) {
    state.ai.history.push({ text, from });
    renderAIMessages();
  }

  aiInput.addEventListener('input', () => {
    aiSendBtn.disabled = aiInput.value.trim() === '';
  });

  aiSendBtn.onclick = () => {
    const userMsg = aiInput.value.trim();
    if (!userMsg) return;
    addAIMessage(userMsg, 'user');
    aiInput.value = '';
    aiSendBtn.disabled = true;
    // Simulate AI response
    setTimeout(() => {
      addAIMessage('Sorry, AI chat is not yet implemented.', 'bot');
    }, 500);
  };

  // Games handlers (simplified)
  gamesList.addEventListener('click', e => {
    if (e.target.classList.contains('game-card')) {
      const game = e.target.getAttribute('data-game');
      state.game.currentGame = game;
      renderGame(game);
      switchTab('games');
      gameBackBtn.style.display = 'inline-block';
    }
  });

  gameBackBtn.onclick = () => {
    state.game.currentGame = null;
    gameContainer.innerHTML = '';
    switchTab('todo');
    gameBackBtn.style.display = 'none';
  };

  function renderGame(game) {
    gameContainer.innerHTML = '';
    if (game === 'memory') {
      gameContainer.textContent = 'Memory game coming soon!';
    } else if (game === 'snake') {
      gameContainer.textContent = 'Snake game coming soon!';
    } else if (game === 'tictactoe') {
      gameContainer.textContent = 'Tic Tac Toe game coming soon!';
    }
  }

  // Settings Handlers
  titleColorPicker.oninput = e => {
    state.settings.titleColor = e.target.value;
    document.documentElement.style.setProperty('--title-color', e.target.value);
    saveToStorage();
  };
  textColorPicker.oninput = e => {
    state.settings.textColor = e.target.value;
    document.documentElement.style.setProperty('--text-color', e.target.value);
    saveToStorage();
  };
  outlineColorPicker.oninput = e => {
    state.settings.outlineColor = e.target.value;
    document.documentElement.style.setProperty('--outline-color', e.target.value);
    saveToStorage();
  };

  backgroundUpload.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      setBackgroundImage(evt.target.result);
      bgRepositionImg.src = evt.target.result;
      bgRepositionContainer.style.display = 'block';
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  };

  bgRepositionBtn.onclick = () => {
    if (!state.settings.backgroundImage) {
      alert('No background image to reposition.');
      return;
    }
    bgRepositionImg.src = state.settings.backgroundImage;
    bgRepositionContainer.style.display = 'block';
  };

  bgRepositionConfirm.onclick = () => {
    // For simplicity, just close modal; advanced reposition not implemented here
    bgRepositionContainer.style.display = 'none';
  };
  bgRepositionCancel.onclick = () => {
    bgRepositionContainer.style.display = 'none';
  };

  widgetWidthInput.onchange = e => {
    const val = parseInt(e.target.value);
    if (val && val >= 300 && val <= 1920) {
      state.settings.widgetWidth = val;
      resizeWidget(val, state.settings.widgetHeight);
      saveToStorage();
    }
  };
  widgetHeightInput.onchange = e => {
    const val = parseInt(e.target.value);
    if (val && val >= 300 && val <= 1080) {
      state.settings.widgetHeight = val;
      resizeWidget(state.settings.widgetWidth, val);
      saveToStorage();
    }
  };
  orientationSelect.onchange = e => {
    state.settings.orientation = e.target.value;
    if (state.settings.backgroundImage) {
      const app = document.getElementById('app');
      app.style.backgroundSize = e.target.value === 'portrait' ? 'auto 100%' : '100% auto';
    }
    saveToStorage();
  };
  darkModeToggle.onchange = e => {
    state.settings.darkMode = e.target.checked;
    updateDarkMode(e.target.checked);
    saveToStorage();
  };

  // Focus mode toggle
  focusModeBtn.onclick = () => {
    state.focusMode = !state.focusMode;
    document.body.classList.toggle('focus-mode', state.focusMode);
  };

  // Task input handling
  todoInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      addTask(todoInput.value, state.taskType);
      todoInput.value = '';
    }
  });

  taskTypeToggle.onclick = () => {
    state.taskType = state.taskType === 'main' ? 'subtask' : 'main';
    taskTypeToggle.textContent = state.taskType === 'main' ? '❤️' : '🧡';
    taskTypeToggle.title = state.taskType === 'main' ? 'Main Task' : 'Subtask';
  };

  clearTasksBtn.onclick = () => {
    if (confirm('Clear all tasks?')) {
      state.tasks = [];
      saveToStorage();
      renderTasks();
    }
  };

  // Timer button handlers
  addTimerBtn.onclick = addTimer;
  clearTimersBtn.onclick = resetAllTimers;

  // Initial render
  loadSettings();
  renderTasks();
  renderTimers();
  renderMusicLibrary();
  renderMusicNowPlaying();
  renderQueue();
  updatePomodoroDisplay();

  // Keyboard navigation for tabs (left/right arrows)
  tabsBar.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      const currentIndex = Array.from(tabButtons).findIndex(btn => btn.id === `tab-${state.activeTab}`);
      let newIndex = currentIndex + (e.key === 'ArrowRight' ? 1 : -1);
      if (newIndex < 0) newIndex = tabButtons.length - 1;
      else if (newIndex >= tabButtons.length) newIndex = 0;
      tabButtons[newIndex].focus();
      switchTab(tabButtons[newIndex].id.replace('tab-', ''));
    }
  });

  // Accessibility: focus styles on buttons for keyboard users
  document.body.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      document.body.classList.add('user-is-tabbing');
    }
  });
  document.body.addEventListener('mousedown', e => {
    document.body.classList.remove('user-is-tabbing');
  });

})();
</script>
</body>
</html>
